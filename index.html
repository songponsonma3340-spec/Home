<!doctype html>

<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Dorm Pro v2 — ครบเครื่อง + แก้ไขรูป QR</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f4f6fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;--success:#16a34a;--danger:#ef4444}
    *{box-sizing:border-box;font-family:'Prompt',sans-serif}
    body{margin:0;background:var(--bg);color:#0f172a;padding:22px}
    .app{max-width:1200px;margin:auto}
    header{display:flex;gap:16px;align-items:center}
    h1{font-size:20px;margin:0}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,.12)}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
    .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(12,20,40,.06)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf6}
    .small{font-size:13px;color:var(--muted)}
    .room-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .room-card{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:12px;border:1px solid rgba(2,6,23,.04)}
    .room-card h3{margin:0 0 6px 0}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    footer{margin-top:18px;text-align:center;color:var(--muted)}
    .toast-wrap{position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{background:#0f172a;color:white;padding:10px 12px;border-radius:10px;opacity:.98}
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(2,6,23,.45);align-items:center;justify-content:center;padding:20px;z-index:999}
    .modal{background:white;border-radius:12px;padding:16px;max-width:860px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,.12)}
    .qr-edit { display:flex; gap:12px; align-items:flex-start; }
    .qr-canvas { width:200px; height:200px; border:1px dashed #e6edf6; display:flex;align-items:center;justify-content:center;padding:8px;background:white }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Manager Dorm Pro v2 — ครบเครื่อง + แก้ไข QR</h1>
        <div class="small">เพิ่มฟีเจอร์ทั้งหมดที่ขอ พร้อมให้แก้ไขรูป QR (อัปโหลดหรือแก้ข้อความเพื่อสร้างใหม่)</div>
      </div>
      <div class="top-actions">
        <input id="globalSearch" placeholder="ค้นหาเลขห้อง/ชื่อ" />
        <button id="openSettings">ตั้งค่า</button>
        <button id="backupBtn" class="ghost">Backup</button>
        <button id="restoreBtn" class="ghost">Restore</button>
        <button id="exportXls" class="ghost">Export Excel</button>
      </div>
    </header><div class="layout">
  <aside class="panel">
    <label>เพิ่ม/แก้ไขห้อง</label>
    <input id="roomId" type="hidden">
    <input id="roomName" placeholder="เลขห้อง - ชื่อผู้เช่า">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <input id="elBefore" type="number" placeholder="มิเตอร์ไฟ ก่อน">
      <input id="elAfter" type="number" placeholder="มิเตอร์ไฟ หลัง">
      <input id="waBefore" type="number" placeholder="มิเตอร์น้ำ ก่อน">
      <input id="waAfter" type="number" placeholder="มิเตอร์น้ำ หลัง">
    </div>
    <label style="margin-top:8px">ค่าบริการเพิ่มเติม</label>
    <input id="feeInternet" type="number" placeholder="อินเทอร์เน็ต">
    <input id="feeClean" type="number" placeholder="ค่าทำความสะอาด">
    <input id="feePark" type="number" placeholder="ค่าที่จอดรถ">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveRoomBtn">บันทึก</button>
      <button id="resetForm" class="ghost">ล้างฟอร์ม</button>
    </div>

    <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff">
    <label>Filter</label>
    <select id="filterSelect"><option value="all">ทั้งหมด</option><option value="paid">ชำระแล้ว</option><option value="unpaid">ยังไม่ชำระ</option></select>
    <label style="margin-top:8px">เลือกรายเดือน</label>
    <input id="monthPicker" type="month">
  </aside>

  <main>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div class="small">รายการห้อง</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="toggleTheme" class="ghost">Toggle Theme</button>
          <button id="printAll" class="ghost">พิมพ์ทั้งหมด</button>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <canvas id="summaryChart" style="max-width:360px;flex:0 0 360px"></canvas>
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center"><div class="small">ยอดรวมเดือนนี้</div><div><strong id="monthTotal">0 ฿</strong></div></div>
          <div style="margin-top:8px"><div class="invoice-preview" id="quickPreview">เลือกห้องเพื่อดูตัวอย่างใบแจ้งหนี้</div></div>
        </div>
      </div>

      <div id="roomList" class="room-list"></div>
    </div>
  </main>
</div>

<footer class="small">สร้างโดย Manager Dorm • รองรับ PDF / XLSX / Backup / EmailJS / QR Edit</footer>

<div id="toasts" class="toast-wrap"></div>
<div id="modal" class="modal-backdrop"><div class="modal"></div></div>

  </div>  <!-- libs -->  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>  <script>
    // persistence
    const LS_ROOMS='md.rooms.v3'; const LS_SETTINGS='md.settings.v3';
    let rooms = JSON.parse(localStorage.getItem(LS_ROOMS)||'[]');
    let settings = JSON.parse(localStorage.getItem(LS_SETTINGS) || JSON.stringify({dormName:'หอพักตัวอย่าง', rateElectric:4.0, rateWater:20.0, otherDefault:0, ownerEmail:'', emailjs_user:'', emailjs_service:'', emailjs_template:''}));
    function saveAll(){ localStorage.setItem(LS_ROOMS, JSON.stringify(rooms)); localStorage.setItem(LS_SETTINGS, JSON.stringify(settings)); }
    function toast(txt,t=2200){ const el=document.createElement('div'); el.className='toast'; el.textContent=txt; document.getElementById('toasts').appendChild(el); setTimeout(()=>el.remove(),t); }

    // helpers
    function calcRoom(r){ const e=(Number(r.elAfter)||0)-(Number(r.elBefore)||0); const w=(Number(r.waAfter)||0)-(Number(r.waBefore)||0); const elec=Math.max(0,e)*settings.rateElectric; const water=Math.max(0,w)*settings.rateWater; const other=(Number(r.feeInternet)||0)+(Number(r.feeClean)||0)+(Number(r.feePark)||0)+(Number(r.other)||0); const total=Math.round((elec+water+other)*100)/100; return {eUsage:e,wUsage:w,elec,water,other,total}; }

    // render
    const roomListEl=document.getElementById('roomList'); function renderRooms(){ roomListEl.innerHTML=''; const q=(document.getElementById('globalSearch').value||'').toLowerCase(); const filter=document.getElementById('filterSelect').value; let monthSum=0; let unpaid=0; rooms.forEach((r,i)=>{ if(q && !(r.name||'').toLowerCase().includes(q)) return; const paid = r.paid===true||r.paid==='true'; if(filter==='paid'&& !paid) return; if(filter==='unpaid'&& paid) return; const c=calcRoom(r); monthSum+=c.total; if(!paid) unpaid++; const card=document.createElement('div'); card.className='room-card'; card.innerHTML=`<h3>${r.name}</h3><div class='small'>ไฟ: ${c.eUsage} หน่วย (${c.elec} บ.) · น้ำ: ${c.wUsage} หน่วย (${c.water} บ.)</div><div class='muted small'>อื่นๆ: ${c.other} บ. | <strong>รวม: ${c.total} บ.</strong></div>`; const actions=document.createElement('div'); actions.className='actions'; const btnEdit=document.createElement('button'); btnEdit.textContent='แก้ไข'; btnEdit.className='ghost'; btnEdit.onclick=()=>openEdit(i); const btnPay=document.createElement('button'); btnPay.textContent=paid?'ยกเลิกชำระ':'จ่ายแล้ว'; btnPay.onclick=()=>{ rooms[i].paid=!rooms[i].paid; saveAll(); renderRooms(); toast('อัปเดตสถานะ'); }; const btnPdf=document.createElement('button'); btnPdf.textContent='ดาวน์โหลด PDF'; btnPdf.onclick=()=>downloadPDF(i); const btnPrint=document.createElement('button'); btnPrint.textContent='พิมพ์'; btnPrint.className='ghost'; btnPrint.onclick=()=>printInvoice(i); const btnQR=document.createElement('button'); btnQR.textContent='QR-Pay/แก้ไข'; btnQR.className='ghost'; btnQR.onclick=()=>openQREdit(i); const btnEmail=document.createElement('button'); btnEmail.textContent='ส่งอีเมล'; btnEmail.className='ghost'; btnEmail.onclick=()=>sendEmailInvoice(i); const btnXls=document.createElement('button'); btnXls.textContent='Export XLS'; btnXls.className='ghost'; btnXls.onclick=()=>exportSingleXLS(i); const btnDelete=document.createElement('button'); btnDelete.textContent='ลบ'; btnDelete.className='ghost'; btnDelete.onclick=()=>{ if(confirm('ลบห้องจริงหรือ?')){ rooms.splice(i,1); saveAll(); renderRooms(); toast('ลบแล้ว'); }}; actions.append(btnEdit,btnPay,btnPdf,btnPrint,btnQR,btnEmail,btnXls,btnDelete); card.appendChild(actions); roomListEl.appendChild(card); }); document.getElementById('monthTotal').textContent = monthSum + ' ฿'; saveAll(); updateChart(); }

    // add/edit
    document.getElementById('saveRoomBtn').addEventListener('click', ()=>{ const id=document.getElementById('roomId').value; const data={ name:document.getElementById('roomName').value||'ไม่มีชื่อ', elBefore:Number(document.getElementById('elBefore').value)||0, elAfter:Number(document.getElementById('elAfter').value)||0, waBefore:Number(document.getElementById('waBefore').value)||0, waAfter:Number(document.getElementById('waAfter').value)||0, feeInternet:Number(document.getElementById('feeInternet').value)||0, feeClean:Number(document.getElementById('feeClean').value)||0, feePark:Number(document.getElementById('feePark').value)||0, other:0, paid:false, createdAt:new Date().toISOString() }; if(id){ rooms[Number(id)] = Object.assign(rooms[Number(id)], data); toast('แก้ไขเรียบร้อย'); } else { rooms.push(data); toast('เพิ่มห้องแล้ว'); } saveAll(); clearForm(); renderRooms(); }); document.getElementById('resetForm').addEventListener('click', clearForm); function clearForm(){ document.getElementById('roomId').value=''; ['roomName','elBefore','elAfter','waBefore','waAfter','feeInternet','feeClean','feePark'].forEach(id=>document.getElementById(id).value=''); }
    function openEdit(i){ const r=rooms[i]; document.getElementById('roomId').value=i; document.getElementById('roomName').value=r.name||''; document.getElementById('elBefore').value=r.elBefore||0; document.getElementById('elAfter').value=r.elAfter||0; document.getElementById('waBefore').value=r.waBefore||0; document.getElementById('waAfter').value=r.waAfter||0; document.getElementById('feeInternet').value=r.feeInternet||0; document.getElementById('feeClean').value=r.feeClean||0; document.getElementById('feePark').value=r.feePark||0; }

    // settings modal
    document.getElementById('openSettings').addEventListener('click', ()=>{ showModal(`<h3>ตั้งค่า</h3>
      <label>ชื่อหอพัก</label><input id='s_name' value='${settings.dormName||''}' />
      <label>ค่าไฟต่อหน่วย</label><input id='s_rateE' type='number' value='${settings.rateElectric||0}' />
      <label>ค่าน้ำต่อหน่วย</label><input id='s_rateW' type='number' value='${settings.rateWater||0}' />
      <label>ค่าอื่นๆ ต่อห้อง (ถ้ามี)</label><input id='s_other' type='number' value='${settings.otherDefault||0}' />
      <hr>
      <h4>EmailJS (ถ้าจะส่งอีเมล)</h4>
      <label>อีเมลเจ้าของ</label><input id='s_owner' value='${settings.ownerEmail||''}' />
      <label>emailjs_user</label><input id='s_euser' value='${settings.emailjs_user||''}' />
      <label>emailjs_service</label><input id='s_eservice' value='${settings.emailjs_service||''}' />
      <label>emailjs_template</label><input id='s_etemplate' value='${settings.emailjs_template||''}' />
      <div style='display:flex;justify-content:flex-end;gap:8px;margin-top:12px'><button id='saveSettingsBtn'>บันทึก</button><button id='closeModal' class='ghost'>ยกเลิก</button></div>
      `); document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{ settings.dormName=document.getElementById('s_name').value; settings.rateElectric=Number(document.getElementById('s_rateE').value)||0; settings.rateWater=Number(document.getElementById('s_rateW').value)||0; settings.otherDefault=Number(document.getElementById('s_other').value)||0; settings.ownerEmail=document.getElementById('s_owner').value; settings.emailjs_user=document.getElementById('s_euser').value; settings.emailjs_service=document.getElementById('s_eservice').value; settings.emailjs_template=document.getElementById('s_etemplate').value; saveAll(); closeModal(); toast('บันทึกการตั้งค่า'); renderRooms(); }); });

    function showModal(html){ document.getElementById('modal').style.display='flex'; document.querySelector('#modal .modal').innerHTML=html; document.getElementById('modal').querySelector('#closeModal')?.addEventListener('click', closeModal); }
    function closeModal(){ document.getElementById('modal').style.display='none'; document.querySelector('#modal .modal').innerHTML=''; }

    // invoice html / print / pdf
    function invoiceHtml(i){ const r=rooms[i]; const c=calcRoom(r); const date=new Date().toLocaleDateString('th-TH'); return `
      <div style='font-family:Prompt,Arial;max-width:720px;padding:18px;color:#0f172a'>
        <div style='display:flex;justify-content:space-between;align-items:center'>
          <div>
            <h2 style='margin:0'>${settings.dormName||'หอพัก'}</h2>
            <div class='small'>ที่อยู่: -</div>
          </div>
          <div style='text-align:right'><div class='small'>วันที่: ${date}</div><h3>ใบแจ้งหนี้</h3></div>
        </div>
        <hr>
        <div>ห้อง: <strong>${r.name}</strong></div>
        <table style='width:100%;margin-top:12px;border-collapse:collapse'>
          <tr><td>ไฟ (${c.eUsage} หน่วย)</td><td style='text-align:right'>${c.elec} ฿</td></tr>
          <tr><td>น้ำ (${c.wUsage} หน่วย)</td><td style='text-align:right'>${c.water} ฿</td></tr>
          <tr><td>อินเทอร์เน็ต</td><td style='text-align:right'>${r.feeInternet} ฿</td></tr>
          <tr><td>ค่าทำความสะอาด</td><td style='text-align:right'>${r.feeClean} ฿</td></tr>
          <tr><td>ค่าที่จอดรถ</td><td style='text-align:right'>${r.feePark} ฿</td></tr>
          <tr><th style='text-align:left'>รวม</th><th style='text-align:right'>${c.total} ฿</th></tr>
        </table>
        <div style='margin-top:14px'>สถานะ: <strong>${r.paid? 'ชำระแล้ว':'ยังไม่ชำระ'}</strong></div>
      </div>
    ` }

    function printInvoice(i){ const w=window.open('','_blank'); w.document.write(invoiceHtml(i)); w.document.close(); w.focus(); }

    async function downloadPDF(i){ const html=invoiceHtml(i); const wrapper=document.createElement('div'); wrapper.style.padding='20px'; wrapper.innerHTML=html; document.body.appendChild(wrapper); const canvas=await html2canvas(wrapper,{scale:2}); const img=canvas.toDataURL('image/png'); document.body.removeChild(wrapper); const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'px',format:[canvas.width,canvas.height]}); doc.addImage(img,'PNG',0,0,canvas.width,canvas.height); const filename=`Invoice_${rooms[i].name.replace(/\s+/g,'_')}.pdf`; doc.save(filename); toast('ดาวน์โหลด PDF แล้ว'); }

    // QR edit modal (generate QR from text OR upload custom image, and allow simple edits)
    function openQREdit(i){ const r=rooms[i]; const c=calcRoom(r); const qrTextInput = `PAY:${c.total}`;
      showModal(`<h3>QR-Pay / แก้ไขรูป QR — ${r.name}</h3>
        <div class='qr-edit'>
          <div>
            <div class='small'>ข้อความสำหรับ QR (แก้แล้วกด "สร้าง QR")</div>
            <input id='qrText' value='${qrTextInput}' />
            <div style='display:flex;gap:8px;margin-top:8px'><button id='genQR'>สร้าง QR</button><button id='downloadQR' class='ghost'>ดาวน์โหลดรูป QR</button></div>
            <hr style='margin:8px 0'>
            <div class='small'>หรืออัปโหลดรูป QR ที่ต้องการ (จะทับรูปที่สร้าง)</div>
            <input id='qrUpload' type='file' accept='image/*' />
            <div class='small' style='margin-top:10px'>หากต้องการปรับขนาด/ครอบรูป ให้ดาวน์โหลดแล้วแก้ไขในโปรแกรมรูปภาพ</div>
          </div>
          <div>
            <div class='qr-canvas' id='qrPreview'>กำลังสร้าง QR...</div>
          </div>
        </div>
        <div style='display:flex;justify-content:flex-end;gap:8px;margin-top:12px'><button id='closeModal'>ปิด</button></div>
      `);

      // generate initial QR
      const preview = document.getElementById('qrPreview'); preview.innerHTML=''; const qr = new QRCode(preview, { text: document.getElementById('qrText').value, width:200, height:200 });
      // handle generate
      document.getElementById('genQR').addEventListener('click', ()=>{
        preview.innerHTML=''; new QRCode(preview, { text: document.getElementById('qrText').value, width:200, height:200 });
      });
      // handle download (convert preview canvas to image)
      document.getElementById('downloadQR').addEventListener('click', ()=>{
        // try to find an img or canvas inside preview
        const img = preview.querySelector('img'); if(img){ const a=document.createElement('a'); a.href=img.src; a.download = `QR_${r.name.replace(/\s+/g,'_')}.png`; a.click(); toast('ดาวน์โหลด QR แล้ว'); return; }
        // fallback: render preview to canvas via html2canvas
        html2canvas(preview).then(canvas=>{ const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download=`QR_${r.name.replace(/\s+/g,'_')}.png`; a.click(); toast('ดาวน์โหลด QR แล้ว'); });
      });
      // upload custom image
      document.getElementById('qrUpload').addEventListener('change', (e)=>{
        const f = e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload = ()=>{ preview.innerHTML = `<img src='${reader.result}' style='max-width:100%;max-height:100%;object-fit:contain' />`; }; reader.readAsDataURL(f);
      });
    }

    // export single xls
    function exportSingleXLS(i){ const r=rooms[i]; const c=calcRoom(r); const ws=XLSX.utils.json_to_sheet([{รายการ:'ไฟ',จำนวน:c.elec},{รายการ:'น้ำ',จำนวน:c.water},{รายการ:'อื่นๆ',จำนวน:c.other},{รายการ:'รวม',จำนวน:c.total}]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Invoice'); XLSX.writeFile(wb,`Invoice_${r.name}.xlsx`); toast('ดาวน์โหลด Excel แล้ว'); }
    document.getElementById('exportXls').addEventListener('click', ()=>{ const arr=rooms.map(r=>{ const c=calcRoom(r); return {room:r.name,electric:c.elec,water:c.water,other:c.other,total:c.total,paid:r.paid}; }); const ws=XLSX.utils.json_to_sheet(arr); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Rooms'); XLSX.writeFile(wb,'Dorm_Export.xlsx'); toast('Export Excel เรียบร้อย'); });

    // backup/restore
    document.getElementById('backupBtn').addEventListener('click', ()=>{ const data={rooms,settings,createdAt:new Date().toISOString()}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dorm-backup-'+new Date().toISOString().slice(0,10)+'.json'; a.click(); toast('ดาวน์โหลด Backup'); });
    document.getElementById('restoreBtn').addEventListener('click', ()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(Array.isArray(d.rooms)) rooms=d.rooms; if(d.settings) settings=d.settings; saveAll(); renderRooms(); toast('กู้คืนข้อมูลสำเร็จ'); }catch(e){ alert('ไฟล์ไม่ถูกต้อง') } }; r.readAsText(f); }; inp.click(); });

    // chart
    const ctx=document.getElementById('summaryChart').getContext('2d'); let chart=null; function updateChart(){ const data=rooms.map((r,i)=>({name:r.name||('R'+i),total:calcRoom(r).total})).sort((a,b)=>b.total-a.total).slice(0,6); const labels=data.map(d=>d.name); const values=data.map(d=>d.total); if(chart) chart.destroy(); chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'ยอด(฿)',data:values}]},options:{plugins:{legend:{display:false}}}}); }

    // print all
    document.getElementById('printAll').addEventListener('click', ()=>{ const w=window.open('','_blank'); let html=''; rooms.forEach((r,i)=>{ html+=invoiceHtml(i)+ '<div style="page-break-after:always"></div>'; }); w.document.write(html); w.document.close(); w.focus(); });

    // send email (EmailJS)
    async function sendEmailInvoice(i){ if(!settings.emailjs_user||!settings.emailjs_service||!settings.emailjs_template){ alert('กรุณาตั้งค่า EmailJS ใน Settings'); return } const html=invoiceHtml(i); const wrapper=document.createElement('div'); wrapper.style.padding='20px'; wrapper.innerHTML=html; document.body.appendChild(wrapper); const canvas=await html2canvas(wrapper,{scale:2}); const img=canvas.toDataURL('image/png'); document.body.removeChild(wrapper); const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'px',format:[canvas.width,canvas.height]}); doc.addImage(img,'PNG',0,0,canvas.width,canvas.height); const pdfBase64=doc.output('datauristring'); emailjs.init(settings.emailjs_user); try{ await emailjs.send(settings.emailjs_service,settings.emailjs_template,{ to_email:settings.ownerEmail, room:rooms[i].name, pdf:pdfBase64 }); toast('ส่งอีเมลเรียบร้อย'); }catch(e){ console.error(e); alert('ส่งอีเมลล้มเหลว'); } }

    // theme toggle
    let dark=false; document.getElementById('toggleTheme').addEventListener('click', ()=>{ dark=!dark; document.body.style.background= dark? '#0b1220': 'var(--bg)'; document.body.style.color = dark? '#e6eef8': '#0f172a'; toast('สลับธีมแล้ว'); });

    // init demo
    if(rooms.length===0){ rooms=[{name:'101 - สมชาย',elBefore:120,elAfter:150,waBefore:40,waAfter:44,feeInternet:200,feeClean:0,feePark:0,paid:false},{name:'102 - มิน',elBefore:200,elAfter:230,waBefore:10,waAfter:14,feeInternet:150,feeClean:100,feePark:0,paid:true}]; }
    renderRooms();

    // expose for debugging
    window._md={rooms,settings,saveAll,renderRooms,openQREdit};
  </script></body>
                                                                                          </html>
